{{define "search"}}<!DOCTYPE html>
<html lang="en">
<head>
    {{template "head" .}}
    <title>Search ‚Äî RainyinSaiGon</title>
    <meta name="description" content="Search blog posts on RainyinSaiGon.">
    <meta property="og:title" content="Search ‚Äî RainyinSaiGon">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://rainyinsaigon.github.io/search/">
</head>
<body class="font-sans text-gray-900 bg-white dark:bg-gray-950 dark:text-gray-100">
    {{template "nav-inner" .}}

    <main class="max-w-5xl mx-auto px-10 py-14">

        <!-- Search bar -->
        <div class="max-w-2xl">
            <h1 class="text-3xl font-extrabold mb-8 text-gray-900 dark:text-white">Search</h1>

            <div class="relative mb-2">
                <!-- Search icon -->
                <div class="pointer-events-none absolute inset-y-0 left-4 flex items-center text-gray-400">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                </div>
                <input
                    id="search-input"
                    type="search"
                    placeholder="Search posts‚Ä¶"
                    autocomplete="off"
                    spellcheck="false"
                    class="w-full pl-11 pr-20 py-3.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 dark:text-gray-100 dark:placeholder-gray-500 shadow-sm focus:outline-none focus:border-blue-400 dark:focus:border-blue-500 focus:shadow-md text-base transition-shadow"
                    style="box-shadow:0 1px 3px rgba(0,0,0,.06)"
                >
                <!-- Keyboard shortcut badge -->
                <div id="shortcut-badge" class="absolute inset-y-0 right-3 flex items-center">
                    <kbd class="hidden sm:inline-flex items-center gap-1 px-2 py-1 rounded-md border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-400 text-xs font-mono select-none">/</kbd>
                </div>
            </div>
            <p class="text-xs text-gray-400 dark:text-gray-500 mb-10 pl-1">Press <kbd class="font-mono text-xs bg-gray-100 dark:bg-gray-800 rounded px-1">/</kbd> to focus ¬∑ <kbd class="font-mono text-xs bg-gray-100 dark:bg-gray-800 rounded px-1">Esc</kbd> to clear</p>

            <!-- Status bar: result count or loading -->
            <div id="search-status" class="hidden mb-6 text-sm font-medium text-gray-500 dark:text-gray-400"></div>

            <!-- Results -->
            <div id="search-results"></div>

            <!-- Hint: shown before typing -->
            <div id="search-hint">
                <p class="text-gray-500 dark:text-gray-400 text-sm mb-5">Start typing to search across all posts by title, tag, or description.</p>
                <div id="tag-suggestions" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- Empty state: shown when query returns nothing -->
            <div id="search-empty" class="hidden py-12 text-center">
                <div class="text-4xl mb-3 select-none">üîç</div>
                <p class="font-semibold text-gray-700 dark:text-gray-300 mb-1">No results found</p>
                <p class="text-sm text-gray-400 dark:text-gray-500" id="search-empty-msg">Try a different keyword or browse by tag.</p>
            </div>

            <!-- Loading state -->
            <div id="search-loading" class="hidden py-10 flex items-center gap-3 text-gray-400 text-sm">
                <svg class="animate-spin" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                Loading search index‚Ä¶
            </div>
        </div>
    </main>

    {{template "footer" .}}

    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
    <script>
    (function() {
        const input      = document.getElementById('search-input');
        const results    = document.getElementById('search-results');
        const status     = document.getElementById('search-status');
        const hint       = document.getElementById('search-hint');
        const emptyEl    = document.getElementById('search-empty');
        const emptyMsg   = document.getElementById('search-empty-msg');
        const loadingEl  = document.getElementById('search-loading');
        const shortcut   = document.getElementById('shortcut-badge');
        const tagSuggest = document.getElementById('tag-suggestions');

        let fuse = null;
        let allData = [];

        // Hide shortcut badge when user is typing
        input.addEventListener('focus', () => shortcut.style.opacity = '0');
        input.addEventListener('blur',  () => { if (!input.value) shortcut.style.opacity = '1'; });

        // Keyboard shortcut: / to focus
        document.addEventListener('keydown', e => {
            if (e.key === '/' && document.activeElement !== input) {
                e.preventDefault();
                input.focus();
                input.select();
            }
            if (e.key === 'Escape' && document.activeElement === input) {
                input.value = '';
                input.blur();
                shortcut.style.opacity = '1';
                history.replaceState(null, '', location.pathname);
                runSearch('');
            }
        });

        // Show loading while fetching
        loadingEl.classList.remove('hidden');
        hint.classList.add('hidden');

        fetch('/search.json')
            .then(r => r.json())
            .then(data => {
                allData = data;
                loadingEl.classList.add('hidden');
                hint.classList.remove('hidden');

                fuse = new Fuse(data, {
                    keys: [
                        { name: 'title',       weight: 0.55 },
                        { name: 'description', weight: 0.30 },
                        { name: 'tags',        weight: 0.15 }
                    ],
                    threshold: 0.38,
                    includeMatches: false
                });

                // Build tag suggestions
                const tagSet = new Set();
                data.forEach(p => (p.tags || []).forEach(t => tagSet.add(t)));
                tagSet.forEach(tag => {
                    const btn = document.createElement('button');
                    btn.textContent = tag;
                    btn.className = 'tag-pill filter-pill filter-pill-inactive text-xs px-3 py-1';
                    btn.onclick = () => {
                        input.value = tag;
                        input.dispatchEvent(new Event('input'));
                        input.focus();
                    };
                    tagSuggest.appendChild(btn);
                });

                // Auto-run if ?q= is in URL
                const q = new URLSearchParams(location.search).get('q');
                if (q) { input.value = q; runSearch(q); }
            })
            .catch(() => {
                loadingEl.classList.add('hidden');
                hint.classList.remove('hidden');
                hint.querySelector('p').textContent = 'Could not load search index. Try refreshing.';
            });

        input.addEventListener('input', () => {
            const q = input.value.trim();
            history.replaceState(null, '', q ? '?q=' + encodeURIComponent(q) : location.pathname);
            runSearch(q);
        });

        function runSearch(q) {
            results.innerHTML = '';
            status.classList.add('hidden');
            status.textContent = '';

            if (!q) {
                emptyEl.classList.add('hidden');
                hint.classList.remove('hidden');
                return;
            }

            hint.classList.add('hidden');

            if (!fuse) return; // still loading

            const hits = fuse.search(q, { limit: 20 });

            if (hits.length === 0) {
                emptyEl.classList.remove('hidden');
                emptyMsg.textContent = 'No posts matching "' + q + '". Try a different keyword or browse by tag.';
                return;
            }

            emptyEl.classList.add('hidden');
            status.classList.remove('hidden');
            status.textContent = hits.length + ' result' + (hits.length !== 1 ? 's' : '') + ' for "' + q + '"';

            hits.forEach(({ item }, i) => {
                const el = document.createElement('article');
                el.className = 'result-card mb-10 pb-10 border-b border-gray-100 dark:border-gray-800 last:border-0 last:mb-0 last:pb-0 group';
                el.style.animationDelay = (i * 0.04) + 's';
                el.innerHTML =
                    '<h2 class="text-xl font-bold leading-snug mb-1">' +
                        '<a class="text-gray-900 dark:text-gray-100 group-hover:text-blue dark:group-hover:text-blue-light transition-colors" style="text-decoration:none" href="/blog/' + item.slug + '">' + escapeHTML(item.title) + '</a>' +
                    '</h2>' +
                    '<p class="text-sm text-gray-400 mb-2">' +
                        escapeHTML(item.date) + ' &middot; ' + item.readTime + ' ' + (item.readTime === 1 ? 'minute' : 'minutes') + ' read' +
                    '</p>' +
                    (item.tags && item.tags.length
                        ? '<div class="flex flex-wrap gap-1.5 mb-3">' +
                            item.tags.map(t => '<span class="tag-pill">' + escapeHTML(t) + '</span>').join('') +
                          '</div>'
                        : '') +
                    '<p class="text-gray-600 dark:text-gray-400 leading-relaxed text-sm">' + escapeHTML(item.description) + '</p>' +
                    '<a class="inline-block mt-3 text-sm font-semibold transition-opacity hover:opacity-70" style="color:#1a6eb5" href="/blog/' + item.slug + '">Read more \u2192</a>';
                results.appendChild(el);
            });
        }

        function escapeHTML(s) {
            return String(s)
                .replace(/&/g,'&amp;')
                .replace(/</g,'&lt;')
                .replace(/>/g,'&gt;')
                .replace(/"/g,'&quot;');
        }
    })();
    </script>
</body>
</html>{{end}}
